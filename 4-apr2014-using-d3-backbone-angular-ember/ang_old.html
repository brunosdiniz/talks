<!-- http://bl.ocks.org/biovisualize/5372077 -->

<!DOCTYPE html>
<meta charset="utf-8">

<html>
<head>
  <style>
    .active {
      background-color: #eee;
    }
  </style>
</head>
<body ng-app="project">

  <div id="demo" ng-controller="CompaniesCtrl">

    <input type="text" ng-model="query">

    <ul>
      <li ng-repeat="c in companies | filter:query" ng-click="select(c)" ng-class="{active: c.isActive}">
        <strong>{{c.name}}</strong>: revenue: {{c.revenue}}, cost: {{c.cost}}
        <!-- <input type="text" ng-model='c.name'> -->
      </li>
    </ul>
    <div class="company-list"></div>
    <div class="chart">
      <d3-bars data="companies" ></d3-bars>
    </div>
  </div>

  <script src="/bower_components/d3/d3.js"></script>
  <script src="/bower_components/angular/angular.js"></script>
  <script>
    angular.module('project', [])

    .controller('CompaniesCtrl', ['$scope', function($scope) {
      $scope.companies = window.companies = [
        {name: "Wayne Enterprises", revenue: 3938, cost: 1423},
        {name: "Stark Enterprises", revenue: 3812, cost: 823},
        {name: "Acme Corp", revenue: 6714, cost: 2990},
        {name: "Dunder Mifflin", revenue: 743, cost: 1304}
      ];

      $scope.select = function(c) {
        c.isActive = !c.isActive;
      }
    }])

    .directive('d3Bars', [function() {
      return {
        restrict: 'EA',
        scope: {
          data: "=",
          label: "@",
          onClick: "&"
        },
        link: function(scope, iElement, iAttrs) {
          var svg = d3.select(iElement[0])
              .append("svg")
              .attr("width", "100%");

          // on window resize, re-render d3 canvas
          window.onresize = function() {
            return scope.$apply();
          };
          scope.$watch(function(){
              return angular.element(window)[0].innerWidth;
            }, function(){
              return scope.render(scope.data);
            }
          );

          // watch for data changes and re-render
          scope.$watch('data', function(newVals, oldVals) {
            return scope.render(newVals);
          }, true);

          // define render function
          scope.render = function(data){
            // remove all previous items before render
            svg.selectAll("*").remove();

            // setup variables
            var width, height, max;
            width = d3.select(iElement[0])[0][0].offsetWidth - 20;
              // 20 is for margins and can be changed
            height = scope.data.length * 35;
              // 35 = 30(bar height) + 5(margin between bars)
            max = 98;
              // this can also be found dynamically when the data is not static
              // max = Math.max.apply(Math, _.map(data, ((val)-> val.count)))

            // set the height based on the calculations above
            svg.attr('height', height);

            //create the rectangles for the bar chart
            svg.selectAll("rect")
              .data(data)
              .enter()
                .append("rect")
                .on("click", function(d, i){return scope.onClick({item: d});})
                .attr("height", 30) // height of each bar
                .attr("width", 0) // initial width of 0 for transition
                .attr("x", 10) // half of the 20 side margin specified above
                .attr("y", function(d, i){
                  return i * 35;
                }) // height + margin between bars
                .transition()
                  .duration(1000) // time of duration
                  .attr("width", function(d){
                    return d.revenue/(max/width);
                  }); // width based on scale

            svg.selectAll("text")
              .data(data)
              .enter()
                .append("text")
                .attr("fill", "#fff")
                .attr("y", function(d, i){return i * 35 + 22;})
                .attr("x", 15)
                .text(function(d){return d[scope.label];});

          };
        }
      };
    }]);
  </script>

</body>
</html>